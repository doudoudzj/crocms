<?phpif (empty($action)) $action = 'list';$groupdb = array(4=>'系统管理员', 3=>'站点管理员', 2=>'内容编辑员', 1=>'注册会员', 0=>'访客');$readonly='';if (SYS_POST){	//添加用户、修改用户资料	if ($action == 'adduser' || $action == 'moduser')	{		$username       = trim($_POST['username']);		$newpassword    = trim($_POST['newpassword']);		$comfirpassword = trim($_POST['comfirpassword']);		$usernickname   = trim($_POST['usernickname']);		$usersitename   = trim($_POST['usersitename']);		$usersiteurl    = trim($_POST['usersiteurl']);		//$hostid         = trim($_POST['hostid']);//管理员编辑用户时会出错		$showgid        = intval($_POST['groupid']);		$userid         = isset($_POST['userid']) ? intval($_POST['userid']) : '';		$email          = $_POST['email'];		$qq             = $_POST['qq'];		$msn            = $_POST['msn'];		if (!$username)		{			redirect('登陆名不能为空');		}		if (strlen($username) > 20)		{			redirect('登陆名不能超过20个字符');		}		$name_key = array("\\",'&',' ',"'",'"','/','*',',','<','>',"\r","\t","\n",'#','$','(',')','%','@','+','?',';','^');		foreach($name_key as $value)		{			if (strpos($username,$value) !== false)			{				redirect('用户名包含敏感字符');			}		}		if ($newpassword != $comfirpassword)		{			redirect('请确认输入的密码一致');		}		if ($action == 'moduser' && !empty($newpassword))		{			if (strpos($newpassword,"\n") !== false || strpos($newpassword,"\r") !== false || strpos($newpassword,"\t") !== false)			{				redirect('密码包含不可接受字符.');			}		}		if ($usersitename)		{			if (!$usersiteurl)			{				redirect('站点地址不能为空！');			}		}		$usersiteurl = char_cv($usersiteurl);		$sqladd = $action == 'moduser' ? ' AND `uid` != '.$userid : '';		if ($usersiteurl)		{			if (!$usersitename)			{				redirect('站点名称不能为空！');			}			if (strlen($usersitename) > 50)			{				redirect('站点名称长度不能超过50字节！');			}			if (!preg_match("#^(http|news|https|ftp|ed2k|rtsp|mms)://#", $usersiteurl))			{				redirect('网站URL错误，需要URL协议前缀');			}			$key = array("\\",' ',"'",'"','*',',','<','>',"\r","\t","\n",'(',')','+',';');			foreach($key as $value)			{				if (strpos($usersiteurl,$value) !== false)				{					redirect('网站URL错误，不能包含特殊字符');				}			}		}		if ($email)		{			$r = $DB->fetch_first('SELECT `uid` FROM `'.DB_PREFIX."user` WHERE `email` = '$email' $sqladd");			if ($r['uid'])			{				redirect('该E-mail已存在');			}		}		if ($msn)		{			$r = $DB->fetch_first('SELECT `uid` FROM `'.DB_PREFIX."user` WHERE `msn` = '$msn' $sqladd");				if ($r['uid'])				{					redirect('该MSN已存在');				}		}		if ($qq)		{			$r = $DB->fetch_first('SELECT `uid` FROM `'.DB_PREFIX."user` WHERE `qq` ='$qq' $sqladd");				if ($r['uid'])				{					redirect('该QQ已存在');				}		}		if ($action == 'adduser')		{			if ($showgid>=$groupid) redirect('不能添加比自己权限高或相等的用户');			$newpassword = md5($newpassword);			$query = $DB->query('SELECT uid FROM `'.DB_PREFIX."user` WHERE `username` = '$username'");			if ($DB->num_rows($query)) redirect('该用户名已被注册');			$DB->query('INSERT INTO `'.DB_PREFIX."user` (`username`, `password`, `usernickname`, `usersiteurl`, `usersitename`, `regdateline`, `regip`, `groupid`, `hostid`) VALUES ('$username', '$newpassword', '$usernickname', '$usersiteurl', '$usersitename', '$timestamp', '$onlineip', '$showgid', '$hostid')");			redirect('添加新用户成功', 'admin.php?file=user&action=list');		}		else if ($action == 'moduser')		{			$sql='UPDATE `'.DB_PREFIX."user` SET `qq` = '$qq', `msn` = '$msn', `groupid` = $showgid, `hostid` = $hostid， `usersiteurl` = '$usersiteurl', `usersitename` = '$usersitename', `usernickname` = '$usernickname', `email` = '$email', `username` = '$username'";			if (!empty($newpassword)) $sql.=",`password`='".md5($newpassword)."'";			$sql.=" WHERE `uid` = '$userid'";			if ($groupid!=4) $sql.=" AND `hostid` = $hostid";			$DB->query($sql);			redirect('用户编辑成功', 'admin.php?file=user&action=mod&userid='.$userid);		}	}	//删除用户(多个)、处理用户其他内容	if ($action == 'del' || $action == 'delusers')	{		$sqladd = $groupid!=4 ? " AND `hostid` = $hostid" : '';		if (empty($_POST['user'])) redirect('请先选择要删除的用户','admin.php?file=user');		$deluids=implode_ids($_POST['user']);		$query = $DB->query('SELECT * FROM `'.DB_PREFIX."user` WHERE `uid` IN (".$deluids.")$sqladd");		$userdb=array();		$delusername='';		while ($user = $DB->fetch_array($query))		{			if ($user['groupid']>=$groupid)  redirect('您无权编辑比自己权限大或同等权限的用户','admin.php?file=user');			$userdb[]=$user;			$delusername.=$user['username'].',';		}		if ($action=='delusers')		{			$DB->query('DELETE FROM `'.DB_PREFIX."user` WHERE `uid` IN (".$deluids.")$sqladd");//删除用户			//删除文章和附件			$aids=array();			if ($_POST['deluserarticle'])			{				include SYS_CORE.'/include/attachment.php';				$query = $DB->query('SELECT `aid` FROM `'.DB_PREFIX."article` WHERE `userid` IN ($deluids)");				while ($article = $DB->fetch_array($query))				{					$aids[]=$article['aid'];				}				$delaids=implode_ids($aids);				if (count($aids)>0)				{					$DB->query('DELETE FROM `'.DB_PREFIX."article` WHERE `aid` IN (".$delaids.")$sqladd");//删除文章					$DB->query('DELETE FROM `'.DB_PREFIX."tag` WHERE `articleid` IN (".$delaids.")$sqladd");//删除tag					//删除附件文件					$delatt=array();					$query= $DB->query('SELECT `filepath`, `thumb_filepath` FROM `'.DB_PREFIX."attachment` WHERE `articleid` IN ($delaids)$sqladd");					removeattachment($query);					$DB->query('DELETE FROM `'.DB_PREFIX."attachment` WHERE `articleid` IN ($delaids)$sqladd");				}			}			redirect('删除用户'.trim($delusername,',').'成功','admin.php?file=user');		}	}}else{	$showgid = isset($_GET['groupid']) ? $_GET['groupid'] : '';	$groupselect[1] = $groupselect[2] = $groupselect[3] = $groupselect[4] = '';	if ($action == 'add')	{		$info['username'] = $info['uid'] = $info['usernickname'] = $info['usersiteurl'] = $info['usersitename'] = $info['qq'] = $info['email'] = $info['msn']='';		$navtitle = '添加用户';		$showgid = 1;		$do = 'adduser';		$groupselect[1] = 'selected';	}	elseif ($action == 'mod')	{		$navtitle = '编辑用户';		$userid = intval($_GET['userid']);		$do = 'moduser';		$useradd = $groupid>3 ? '' : ' AND `hostid` = '.$hostid;		$info = $DB->fetch_first('SELECT * FROM `'.DB_PREFIX."user` WHERE `uid` = '$userid' $useradd");		if ($info['groupid'] >= $groupid && $info['username'] != $username) redirect('您无权编辑比自己权限大或同等权限的用户','admin.php?file=user');		$groupselect[$info['groupid']] = 'selected';		$showgid = $info['groupid'];		$readonly = 'readonly=“true"';	}	elseif ($action == 'list')	{		if ($page)		{			$start_limit = ($page - 1) * 30;		}		else		{			$start_limit = 0;			$page = 1;		}		$sqladd = " WHERE `hostid` = '$hostid' ";		$pagelink = '';		//查看是否发表过评论		$subnav = '所有用户';		$lastpost = (!isset($_GET['lastpost'])) ? '' : $_GET['lastpost'] ;		if ($lastpost == 'already')		{			$sqladd .= " AND `lastpost` <> '0'";			$pagelink .= '&lastpost=already';			$subnav = '发表过评论的用户';		}		elseif ($lastpost == 'never')		{			$sqladd .= " AND `lastpost` = '0'";			$pagelink .= '&lastpost=never';			$subnav = '从未发表过评论的用户';		}		//查看用户组		if ($showgid && in_array($showgid,array_flip($groupdb)))		{			$sqladd .= " AND `groupid` = '$showgid'";			$pagelink .= '&groupid='.$showgid;			$subnav = $groupdb[$showgid].'的用户';		}		//查看IP段		$ip =isset($_GET['ip'])? char_cv($_GET['ip']):'';		if ($ip)		{			$frontlen = strrpos($ip, '.');			$ipc = substr($ip, 0, $frontlen);			$sqladd .= " AND (loginip LIKE '%".$ipc."%')";			$pagelink .= '&ip='.$ip;			$subnav  = '上次登陆IP为['.$ip.']同一时段的相关用户';		}		//搜索用户		$srhname =isset($_GET['srhname']) ? ( char_cv($_GET['srhname'] ? $_GET['srhname'] : $_POST['srhname'])) : '';		if ($srhname)		{			$sqladd .= " AND (BINARY username LIKE '%".str_replace('_', '\_', $srhname)."%' OR `username` = '$srhname')";			$pagelink .= '&srhname='.$srhname;		}		//排序		$order =isset($_GET['order'])? $_GET['order']:'';		if ($order && in_array($order,array('username', 'logincount', 'regdateline')))		{			$orderby = $order;			$orderdb = array('username'=>'用户名','logincount'=>'登陆次数','regdateline'=>'注册时间');			$subnav = '以'.$orderdb[$order].'降序查看全部用户';			$pagelink .= '&order='.$order;		}		else		{			$orderby = 'uid';		}		$total = $DB->num_rows($DB->query('SELECT `uid` FROM `'.DB_PREFIX.'user` '.$sqladd));		$multipage = multi($total, 30, $page, 'admin.php?file=user&action=list'.$pagelink);		$query = $DB->query('SELECT * FROM `'.DB_PREFIX."user` $sqladd ORDER BY $orderby DESC LIMIT $start_limit, 30");		$userdb = array();		//对在视图界面输出的结果做下特殊处理		while ($user = $DB->fetch_array($query))		{			$user['lastpost'] = $user['lastpost'] ? date('Y-m-d H:i',$user['lastpost']) : '从未发表';			$user['regdateline'] = date('Y-m-d',$user['regdateline']);			$user['usersitename'] = $user['usersitename'] ? '<a href="'.$user['usersiteurl'].'" target="_blank" title="访问用户站点：'.$user['usersiteurl'].'">'.$user['usersitename'].'</a>' : '<font color="#FF0000">NULL</font>';			$user['email'] = $user['email']? '<a href="mailto:'.$user['email'].'" target="_blank" title="发送邮件给用户：'.$user['email'].'">发送邮件</a>' : '<font color="#FF0000">NULL</font>';			$user['logintime'] = $user['logintime'] ? date('Y-m-d H:i',$user['logintime']) : '从未登陆';			$user['loginip'] = $user['loginip'] ? $user['loginip'] : '从未登陆';			$user['group'] = $groupdb[$user['groupid']];			$user['disabled'] = $user['groupid'] >= $groupid ? 'disabled' : '';			$userdb[] = $user;		}		unset($user);		$DB->free_result($query);	} //end list}